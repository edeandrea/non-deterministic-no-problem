@startuml
skinparam backgroundColor white
skinparam BoxPadding 10
skinparam ParticipantPadding 20
skinparam MaxMessageSize 200
autonumber

' --- INCLUDES & ICONS ---
!include <tupadr3/devicons2/quarkus>
!include <tupadr3/font-awesome-5/robot>
!include <tupadr3/font-awesome-5/brain>
!include <tupadr3/font-awesome-5/database>

' --- CUSTOM STYLES ---
' This hides the border/shadow for items marked as <<nobox>>
' effectively showing just the icon and text.
skinparam participant {
    BorderColor<<nobox>> white
    BackgroundColor<<nobox>> white
    Shadowing<<nobox>> false
}

' --- MANUAL OTel ICON ---
sprite $otel [16x16/16] {
0000000000000000
0000000000000000
0055550000555500
0555555005555550
0555555005555550
0555555005555550
0055550000555500
0000000000000000
0055550000555500
0555555005555550
0555555005555550
0555555005555550
0055550000555500
0000000000000000
0000000000000000
0000000000000000
}

title Sequence: Rescoring

actor "User/Client" as User

' --- MAIN APPLICATION BOX ---
box "<$quarkus>\nApplication" #F9F9F9
    participant "<$robot>\nLangChain4j" as LC4J <<Library>>
    participant "<$quarkus>\nScoring Extension\n('Rescore' mode)" as SE <<Library>>
end box


' --- EXTERNAL DEPENDENCIES ---
participant "<$brain>\nOpenAI" as OpenAI #FFFFFF
participant "<$quarkus>\nScoring Service" as CSS #E8F5E9
participant "<$database>\nInteraction &\nScoring DB" as DB
participant "<$brain>\nGemini" as Gemini #FFFFFF
participant "<$otel>\nOTel Collector" as OTel #FFF3E0

' === THE FLOW ===

User -> LC4J : Request
activate LC4J

' 1. SYNCHRONOUS CALL TO OPENAI
LC4J -> OpenAI : <<sync HTTP>>\nSend request
activate OpenAI
OpenAI --> LC4J : Response
deactivate OpenAI

' 2. HANDOFF TO EXTENSION
LC4J -> SE : Fire event
activate SE

' 3. ASYNC OBSERVABILITY
SE ->> OTel : <<async gRPC>>\nSend Metrics/Traces/Logs

' 5. ASYNC SCORING
SE ->> CSS : <<async>>\nSubmit Interaction for Rescoring
activate CSS

group Rescoring
    CSS -> DB : Fetch all previous interactions
    activate DB
    DB --> CSS
    deactivate DB
    CSS -> CSS : Organize previous interactions as samples
    CSS -> Gemini : <b>Model as judge</b>\nPass all previous interactions and current interaction's response
    activate Gemini
    Gemini --> CSS : Result
    deactivate Gemini
    CSS -> DB : Persist Interaction & Rescore
    activate DB
    DB --> CSS
    deactivate DB

    CSS ->> OTel : <<async gRPC>>\nSend Metrics/Traces/Logs
end

CSS --> SE : Score
deactivate CSS

alt Score > threshold
    SE --> LC4J : Original Response
    LC4J --> User : Original Response
else Score < threshold
    SE --> LC4J : <font color=red><b>Throw RescoreBelowThresholdException</b></font>

    deactivate SE
    LC4J --> User : <font color=red><b>Error</b></font>
    deactivate LC4J
end

@enduml